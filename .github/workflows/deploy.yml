name: Deploy to Oracle VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: ðŸš€ Deploy to Oracle
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¢ Announce Maintenance (1m Warning)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script: |
            echo "ðŸ“¢ Triggering Maintenance Alert on Server..."
            curl -s -X POST http://localhost:3002/api/admin/maintenance \
            -H "Content-Type: application/json" \
            -d '{"secret": "puckoff_deploy_secret_2026", "duration": 1}' || echo "âš ï¸ Failed to announce, but continuing..."
      
      - name: â³ Waiting 1 Minute for Players to Finish...
        run: sleep 60

      - name: ðŸšš Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e
            echo "=== Connected to Oracle Cloud ==="
            cd puckOff

            echo "=== PRE-PULL: Cleaning untracked conflicts ==="
            git checkout -- . 2>/dev/null || true
            git clean -fd scripts/ 2>/dev/null || true

            echo "=== PULLING LATEST CODE ==="
            git fetch origin main
            git reset --hard origin/main
            echo "=== NOW ON COMMIT ==="
            git log --oneline -1

            echo "=== BUILDING CONTAINERS (FRESH) ==="
            sudo docker compose build --no-cache frontend backend
            echo "=== STOPPING OLD CONTAINERS ==="
            sudo docker stop puckoff-frontend puckoff-backend 2>/dev/null || true
            sudo docker rm -f puckoff-frontend puckoff-backend 2>/dev/null || true
            # Also remove any orphaned containers with similar names
            sudo docker rm -f $(sudo docker ps -aq --filter "name=puckoff-") 2>/dev/null || true
            echo "=== STARTING FRESH CONTAINERS ==="
            sudo docker compose up -d --no-deps --force-recreate frontend backend

            echo "=== CLEANING UP ==="
            sudo docker image prune -f

            echo "=== VERIFYING ==="
            sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo "âœ… Deployment Complete!"
