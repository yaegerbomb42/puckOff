name: Deploy to Oracle VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: ðŸš€ Deploy to Oracle
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¢ Announce Maintenance (10m Warning)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script: |
            echo "ðŸ“¢ Triggering Maintenance Alert on Server..."
            curl -v -X POST http://localhost:3002/api/admin/maintenance \
            -H "Content-Type: application/json" \
            -d '{"secret": "puckoff_deploy_secret_2026", "duration": 10}' || echo "âš ï¸ Failed to announce, but continuing..."
      
      - name: â³ Waiting 10 Minutes for Players to Finish...
        run: sleep 600

      - name: ðŸšš Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script: |
            echo "=== Connected to Oracle Cloud ==="
            cd puckOff
            echo "=== PRE-PULL STATUS ==="
            git status
            git log --oneline -1
            echo "=== PULLING LATEST CODE ==="
            git stash || true
            git pull --ff-only origin main
            echo "=== POST-PULL STATUS ==="
            git log --oneline -3
            echo "=== REBUILDING CONTAINERS (NO CACHE) ==="
            sudo docker compose up -d --build --no-cache --remove-orphans 2>&1 | tail -50
            echo "=== CLEANING UP ==="
            sudo docker image prune -f
            echo "=== VERIFYING CONTAINERS ==="
            sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo "âœ… Deployment Complete!"
